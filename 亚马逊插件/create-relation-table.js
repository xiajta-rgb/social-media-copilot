// 演示如何在 Supabase 中创建关联表
const { createClient } = require('@supabase/supabase-js');

// 使用正确的 Supabase 配置
const SUPABASE_CONFIG = {
  url: "https://xarrfzqxwpuurjrsaant.supabase.co",
  key: "sb_secret_HH69MF3MkF6z46Oof0b8Iw_F164QI-f"
};

const supabase = createClient(
  SUPABASE_CONFIG.url,
  SUPABASE_CONFIG.key
);

// 演示关联表设计和使用
async function demoRelationTable() {
  console.log('开始演示关联表设计...');
  
  try {
    // 1. 先查看当前 account 表结构
    console.log('\n1. 当前 account 表结构...');
    const { data: accountData, error: accountError } = await supabase
      .from('account')
      .select('*')
      .limit(1);
    
    if (accountError) {
      console.error('查询 account 表失败:', accountError.message);
    } else {
      console.log('account 表数据示例:', accountData);
    }
    
    // 2. 创建用户数据关联表（如果不存在）
    console.log('\n2. 设计关联表...');
    console.log('关联表设计原则:');
    console.log('   - 外键关联到 account 表的 id 字段');
    console.log('   - 使用 account_id 作为外键字段');
    console.log('   - 存储用户的其他数据字段');
    
    // 在 Supabase 控制台中创建关联表的 SQL 示例:
    /*
    CREATE TABLE IF NOT EXISTS user_profiles (
      id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      account_id bigint NOT NULL REFERENCES account(id) ON DELETE CASCADE,
      email text,
      full_name text,
      avatar_url text,
      phone text,
      created_at timestamptz DEFAULT now() NOT NULL,
      updated_at timestamptz DEFAULT now() NOT NULL
    );
    */
    
    // 3. 演示如何插入关联数据
    console.log('\n3. 插入关联数据示例...');
    
    // 假设我们有一个 account_id = 5 的用户
    const accountId = 5;
    const userProfileData = {
      account_id: accountId,
      email: "123456@example.com",
      full_name: "测试用户",
      avatar_url: "https://example.com/avatar.jpg",
      phone: "13800138000"
    };
    
    console.log('要插入的用户资料:', userProfileData);
    
    // 4. 演示如何查询关联数据（使用 JOIN）
    console.log('\n4. 查询关联数据示例...');
    console.log('使用 JOIN 查询用户及其资料的 SQL:');
    console.log('   SELECT a.*, p.* FROM account a');
    console.log('   LEFT JOIN user_profiles p ON a.id = p.account_id');
    console.log('   WHERE a.id = 5');
    
    // 5. 演示 Supabase JavaScript SDK 的关联查询
    console.log('\n5. Supabase SDK 关联查询示例...');
    const { data: joinedData, error: joinedError } = await supabase
      .from('account')
      .select(`
        *, 
        user_profiles (*)
      `)
      .eq('id', accountId)
      .single();
    
    if (joinedError) {
      console.log('关联查询失败（可能表不存在）:', joinedError.message);
      console.log('需要先在 Supabase 控制台创建 user_profiles 表');
    } else {
      console.log('关联查询结果:', joinedData);
    }
    
    // 6. 总结关联表设计要点
    console.log('\n6. 关联表设计总结:');
    console.log('   ✅ 使用外键关联到主表的主键');
    console.log('   ✅ 外键命名规范：主表名_id');
    console.log('   ✅ 添加 ON DELETE CASCADE 约束，自动删除关联数据');
    console.log('   ✅ 给关联字段添加索引，提高查询效率');
    console.log('   ✅ 使用 Supabase 的关系查询功能获取关联数据');
    
  } catch (error) {
    console.error('演示失败:', error.message);
  }
}

demoRelationTable();
